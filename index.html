<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="manifest" href="manifest.json">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#121212">

<script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('sw.js');
  }
</script>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>FitBsk</title>

<link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='50' fill='%231b1b1b'/%3E%3Ccircle cx='50' cy='50' r='40' fill='none' stroke='%2376d900' stroke-width='10'/%3E%3Ccircle cx='50' cy='50' r='15' fill='%233a3a3a'/%3E%3C/svg%3E">

<style>
    body {
    /* Previne scroll-ul de tip "refresh" pe mobil */
    overscroll-behavior-y: contain;
}

/* Stil pentru bara de status pe iOS */
@media screen and (display-mode: standalone) {
    .card {
        height: 100vh;
        max-height: 100vh;
        width: 100vw;
        max-width: none;
        border-radius: 0;
    }
}

    :root { 
        --primary: #76d900; --bg: #121212; --card: #1b1b1b; 
        --track: #d9dbd0; --bonus: #00e5ff; 
        --danger: #ff3b30; --text-muted: #888; --input-bg: #2a2a2a;
    }
    
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

    body { 
        margin: 0; background: var(--bg); color: #eee; 
        font-family: system-ui, -apple-system, sans-serif; 
        user-select: none; -webkit-user-select: none;
        overflow: hidden; position: fixed; 
        width: 100%; height: 100%;
        display: flex; align-items: center; justify-content: center;
    }

    .card {
        width: 94vw; max-width: 420px; height: 90vh; max-height: 800px;
        padding: 30px 20px 15px 20px;
        background: var(--card); border-radius: 22px; 
        text-align: center; position: relative; overflow: hidden;
        display: flex; flex-direction: column;
        box-shadow: 0 20px 40px rgba(0,0,0,0.4);
        border: 1px solid transparent;
    }

    /* --- HEADER --- */
    .top-stats-container { display: flex; justify-content: space-between; align-items: flex-start; height: 70px; margin-bottom: 20px; flex-shrink: 0; position: relative; }
    
    .stat-box { display: flex; flex-direction: column; width: 80px; }
    .stat-box.center { flex: 1; align-items: center; cursor: pointer; }
    .stat-box.left { align-items: flex-start; text-align: left; }
    .stat-box.right { align-items: flex-end; text-align: right; }

    /* SLOT MACHINE LABEL STYLES */
    .label-mask {
        height: 12px; 
        overflow: hidden;
        display: flex; flex-direction: column; justify-content: flex-start;
        opacity: 0.5; font-weight: 700; letter-spacing: 1px;
    }
    .label-reel {
        display: flex; flex-direction: column;
        transition: transform 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
    }
    .label-reel span {
        font-size: 10px; text-transform: uppercase;
        height: 12px; line-height: 12px;
        display: block; text-align: right;
    }

    .label { 
        font-size: 11px; opacity: 0.5; text-transform: uppercase; font-weight: 700; letter-spacing: 1px; 
        display: flex; align-items: center; gap: 4px; justify-content: center;
    }
    .label span.arrow { font-size: 8px; margin-top: 1px; }

    .val-text { font-size: 32px; font-weight: 800; line-height: 1; margin-top: 5px; transition: color 0.3s ease; }
    
    .ex-title { 
        font-size: 24px; font-weight: 800; color: #fff; margin-top: 2px; 
        padding-bottom: 5px; display: flex; align-items: center; justify-content: center;
    }

    .bonus-text { color: var(--bonus); }
    .rem-text { color: var(--primary); }

    /* --- SLIDER & WHEEL --- */
    .slider-container { position: relative; width: 100%; height: 32px; margin-bottom: 25px; flex-shrink: 0; background: var(--track); border-radius: 16px; overflow: hidden; }
    
    .progress-fill { 
        position: absolute; top: 0; left: 0; height: 100%; width: 0%; 
        background-color: var(--primary); border-radius: 16px; z-index: 1; 
        transition: width 0.1s linear, background-color 0.3s ease;
        background-image: linear-gradient(45deg, rgba(255,255,255,0.15) 25%, transparent 25%, transparent 50%, rgba(255,255,255,0.15) 50%, rgba(255,255,255,0.15) 75%, transparent 75%, transparent); 
        background-size: 30px 30px; 
        animation: move-stripes 1s linear infinite; 
    }
    
    .slider-container.bonus-mode .progress-fill {
        background-color: var(--bonus);
        animation: move-stripes 0.5s linear infinite;
    }

    @keyframes move-stripes { from { background-position: 0 0; } to { background-position: 30px 0; } }
    
    input[type="range"] { -webkit-appearance: none; width: 100%; height: 100%; background: transparent; outline: none; border: none; position: relative; z-index: 5; margin: 0; }
    input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; width: 0; height: 32px; }

    .wheel-container { position: relative; width: 220px; height: 220px; margin: 0 auto 20px; flex-shrink: 0; display: flex; align-items: center; justify-content: center; touch-action: none; border-radius: 50%; }
    .wheel { position: absolute; width: 100%; height: 100%; border-radius: 50%; background: repeating-conic-gradient(from 0deg, #2e2e2e 0deg 6deg, #1b1b1b 6deg 12deg); box-shadow: inset 0 0 40px rgba(0,0,0,0.9); transition: transform 0.12s ease-out; }
    
    .wheel-center { 
        position: relative; z-index: 10; width: 120px; height: 120px; border-radius: 50%; 
        background: radial-gradient(#3a3a3a, #1e1e1e); display: flex; align-items: center; justify-content: center; 
        box-shadow: 0 4px 15px rgba(0,0,0,0.6); 
        cursor: default; pointer-events: none;
        transition: transform 0.1s, box-shadow 0.3s;
    }
    .wheel-center.can-save { cursor: pointer; pointer-events: auto; }
    .wheel-center.can-save:active { transform: scale(0.95); box-shadow: 0 2px 10px rgba(0,0,0,0.8); }
    
    #inc { 
        font-size: 42px; font-weight: 700; color: var(--primary); 
        line-height: 1; margin-top: -2px; 
        opacity: 0; transition: opacity 0.3s ease; 
        pointer-events: none; 
    }
    #inc.show { opacity: 1; }

    .evaporate { transform: translateY(-15px) scale(1.1); opacity: 0 !important; transition: transform 0.4s ease-out, opacity 0.4s ease-out !important; }

    /* --- STATS ZONE RESTRANS --- */
    .stats-zone { 
        cursor: pointer; padding: 15px; border-radius: 15px; 
        transition: 0.2s; flex-shrink: 0; 
        align-self: center; width: auto; min-width: 150px; 
    }
    .stats-zone:active { background-color: #252525; transform: scale(0.98); }

    .done-val { font-size: 60px; font-weight: 800; color: #fff; line-height: 1; }
    .buttons { display: flex; gap: 12px; margin-top: auto; width: 100%; }
    .buttons button { flex: 1; padding: 20px 0; font-size: 20px; border-radius: 14px; border: none; background: #2a2a2a; color: #eee; cursor: pointer; font-weight: bold; }

    /* --- PANELS --- */
    .panel { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: var(--card); z-index: 50; display: none; flex-direction: column; padding: 20px; }
    
    .scroll-list { overflow-y: auto; flex: 1; -ms-overflow-style: none; scrollbar-width: none; padding-bottom: 10px; cursor: grab; }
    .scroll-list::-webkit-scrollbar { display: none; }
    
    .panel-hint { font-size: 10px; color: var(--text-muted); text-align: center; margin-bottom: 15px; opacity: 0.7; font-weight: 500; }

    /* SWIPE ITEMS */
    .swipe-container { position: relative; height: 60px; max-height: 60px; margin-bottom: 10px; border-radius: 12px; background-color: var(--danger); overflow: hidden; transition: max-height 0.35s ease, margin 0.35s ease, opacity 0.3s ease; transform-origin: top; }
    .swipe-container.deleting { max-height: 0; margin-bottom: 0; opacity: 0; transform: scale(0.95); }
    .delete-btn { position: absolute; right: 0; top: 0; bottom: 0; width: 80px; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 12px; z-index: 1; cursor: pointer; }
    .swipe-content { position: relative; z-index: 2; background-color: #252525; width: 100%; height: 100%; display: flex; justify-content: space-between; align-items: center; padding: 0 15px; transition: transform 0.2s ease-out; touch-action: pan-y; cursor: grab; }
    
    /* ISTORIC STYLING */
    .hist-left { display: flex; flex-direction: column; align-items: flex-start; justify-content: center; }
    .hist-name { font-size: 16px; font-weight: 700; color: #fff; line-height: 1.2; }
    .hist-time { font-size: 11px; color: var(--text-muted); margin-top: 2px; }
    .hist-val { font-weight: 800; font-size: 20px; color: var(--primary); }
    
    .discrete-hint { font-size: 9px; color: var(--text-muted); text-align: center; opacity: 0.3; font-weight: 400; font-style: italic; }
    .history-header-hint { margin-bottom: 10px; }
    .main-page-hint { margin-top: 5px; }

    /* EXERCISE LIST */
    .ex-list-item { background: #252525; height: 60px; border-radius: 12px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; padding: 0 15px; cursor: pointer; transition: background 0.2s; }
    .ex-list-item:active { background: #333; }
    .ex-item-name { font-size: 18px; font-weight: bold; }
    
    .ex-status-dot { width: 10px; height: 10px; border-radius: 50%; background-color: #444; transition: background-color 0.3s; }
    .ex-status-dot.active { background-color: var(--primary); box-shadow: 0 0 5px var(--primary); }
    
    .add-ex-item { height: 60px; border-radius: 12px; background: #222; border: 1px dashed #444; display: flex; align-items: center; justify-content: center; cursor: pointer; color: var(--primary); font-weight: bold; font-size: 14px; margin-bottom: 10px; }
    .add-ex-item:active { background: #333; }

    /* SETTINGS */
    .setting-group { text-align: left; margin-bottom: 25px; background: #252525; padding: 15px; border-radius: 12px; }
    .setting-group label { display: block; font-size: 12px; color: var(--primary); font-weight: bold; margin-bottom: 10px; text-transform: uppercase; }
    .custom-input { width: 100%; background: var(--input-bg); border: 1px solid #444; color: #fff; padding: 12px; border-radius: 8px; font-size: 16px; outline: none; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
    select, input[type="number"], input[type="text"] { width: 100%; background: var(--input-bg); border: 1px solid #444; color: #fff; padding: 12px; border-radius: 8px; font-size: 16px; outline: none; }
    
    .close-btn { background: var(--primary); color: #000; font-weight: bold; border: none; padding: 18px 25px; border-radius: 14px; width: 100%; cursor: pointer; font-size: 18px; margin-top: auto; flex-shrink: 0; }
    
    .delete-ex-btn { 
        background: transparent; color: var(--danger); font-weight: bold; 
        border: 1px solid var(--danger); padding: 10px 20px; border-radius: 10px; 
        width: auto; cursor: pointer; font-size: 12px; 
        margin: 10px auto; display: block; opacity: 0.7;
    }
    .delete-ex-btn:active { opacity: 1; background: rgba(255, 59, 48, 0.1); }

    /* NAV & CALENDAR */
    .hist-nav { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; background: #252525; padding: 10px; border-radius: 12px; flex-shrink: 0; }
    
    .nav-arrow { padding: 10px 20px; font-size: 20px; font-weight: bold; color: var(--primary); cursor: pointer; transition: opacity 0.2s, color 0.2s; }
    .nav-arrow.disabled { color: var(--text-muted); opacity: 0.3; pointer-events: none; }
    
    .nav-date { font-size: 16px; font-weight: bold; cursor: pointer; color: #fff; }

    /* ADVANCED MENU UPDATED */
    .advanced-section { margin-bottom: 10px; flex-shrink: 0; border-top: 1px solid #333; padding-top: 10px; }
    .advanced-toggle { font-size: 11px; color: var(--text-muted); cursor: pointer; padding: 2px; font-weight: bold; text-transform: uppercase; letter-spacing: 1px; }
    
    .advanced-menu { 
        overflow: hidden; 
        height: 0; 
        transition: height 0.3s ease; 
        display: flex; 
        flex-wrap: wrap; /* Permite trecerea pe randul urmator */
        gap: 10px; 
        margin-top: 5px; 
    }
    /* Inaltime crescuta pentru a acomoda 2 randuri de butoane */
    .advanced-menu.open { height: 90px; } 
    
    .adv-btn { 
        flex: 1 1 45%; /* Fiecare buton ia cam jumatate, minus gap */
        background: #333; color: #fff; 
        border: 1px solid #444; border-radius: 8px; 
        font-size: 11px; cursor: pointer; font-weight: bold; padding: 0; 
        height: 40px; /* Inaltime fixa pentru a calcula height-ul containerului */
    }

    /* Calendar Grid */
    .cal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .cal-nav-btn { font-size: 20px; padding: 10px; cursor: pointer; color: var(--primary); font-weight: bold; width: 40px; text-align: center; }
    .cal-title-container { display: flex; gap: 0; font-size: 18px; font-weight: bold; flex: 1; justify-content: center; overflow: hidden; }
    .cal-title-part { cursor: pointer; padding: 5px 10px; border-radius: 8px; display: none; }
    .cal-title-part.active { display: block; color: var(--primary); }
    .cal-grid { display: grid; gap: 10px; flex: 1; align-content: start; overflow-y: auto; }
    .cal-grid.days { grid-template-columns: repeat(7, 1fr); }
    .cal-day-header { font-size: 12px; color: var(--text-muted); font-weight: bold; padding-bottom: 10px; }
    .cal-cell { aspect-ratio: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 50%; font-size: 14px; position: relative; cursor: pointer; }
    .cal-cell.today { border: 1px solid var(--primary); color: var(--primary); }
    .cal-cell.selected { background: var(--primary); color: #000; font-weight: bold; }
    .cal-cell.disabled { opacity: 0.3; pointer-events: none; }
    .cal-dot { width: 4px; height: 4px; background: var(--bonus); border-radius: 50%; margin-top: 2px; display: none; }
    .cal-cell.has-data .cal-dot { display: block; }
    .cal-grid.months, .cal-grid.years { grid-template-columns: repeat(3, 1fr); align-content: center; gap: 15px; }
    .cal-big-cell { padding: 20px 0; background: #252525; border-radius: 12px; cursor: pointer; font-weight: bold; font-size: 15px; position: relative; }
    .cal-big-cell.current { border: 1px solid var(--primary); color: var(--primary); }
    .cal-big-cell.has-data .cal-dot { display: block; position: absolute; bottom: 8px; left: 50%; transform: translateX(-50%); }

    /* COPYRIGHT FOOTER UPDATED */
    .copyright { 
        margin-top: 15px; font-size: 10px; color: var(--text-muted); opacity: 0.4; 
        flex-shrink: 0; font-family: monospace; letter-spacing: 0.5px;
        display: flex; flex-direction: column; align-items: center; gap: 2px;
    }
</style>
</head>
<body>

<div class="card" id="main-card">
    <div id="exercises-panel" class="panel" style="z-index: 70;">
        <h2 style="margin-top:0; margin-bottom:15px" data-key="chooseEx">Choose Exercise</h2>
        <div id="exercises-list" class="scroll-list"></div>
        <button class="close-btn" onclick="togglePanel('exercises-panel')" data-key="back">BACK</button>
    </div>

    <div id="history-panel" class="panel">
        <div class="hist-nav">
            <div class="nav-arrow" id="nav-left" onclick="navHistoryDay(-1)">&lt;</div>
            <div class="nav-date" onclick="openCalendar('history')">
                <span id="nav-date-display">Today</span>
            </div>
            <div class="nav-arrow" id="nav-right" onclick="navHistoryDay(1)">&gt;</div>
        </div>
        <div class="discrete-hint history-header-hint" data-key="swipeHint">Swipe left to delete</div>
        <div id="history-list" class="scroll-list"></div>
        <div class="advanced-section">
            <div class="advanced-toggle" onclick="toggleAdvanced()"><span data-key="advOpt">Advanced Options</span> ▼</div>
            <div id="advanced-menu" class="advanced-menu">
                <button class="adv-btn" onclick="exportData()">⬇ Export</button>
                <button class="adv-btn" onclick="document.getElementById('import-file').click()">⬆ Import</button>
                
                <button class="adv-btn" onclick="toggleLang()">Lang: <span id="lang-disp">EN</span></button>
                <button class="adv-btn" id="new-feature-btn" style="opacity:0.5; cursor: default;">...</button>
                
                <input type="file" id="import-file" style="display:none" onchange="importData(this)">
            </div>
        </div>
        <button class="close-btn" onclick="togglePanel('history-panel')" data-key="back">BACK</button>
    </div>

    <div id="calendar-panel" class="panel" style="z-index: 80;">
        <div class="cal-header">
            <div class="cal-nav-btn" onclick="navCalendar(-1)">&lt;</div>
            <div class="cal-title-container">
                <div id="cal-title-month" class="cal-title-part" onclick="setCalendarView('months')" data-key="month">Month</div>
                <div id="cal-title-year" class="cal-title-part" onclick="setCalendarView('years')" data-key="year">Year</div>
            </div>
            <div class="cal-nav-btn" onclick="navCalendar(1)">&gt;</div>
        </div>
        <div id="cal-grid" class="cal-grid days"></div>
        <button class="close-btn" onclick="closeCalendar()" data-key="close">CLOSE</button>
    </div>

    <div id="settings-panel" class="panel">
        <h2 style="margin-top:0; margin-bottom: 25px;" data-key="exSetup">Exercise Setup</h2>
        <div class="setting-group">
            <label data-key="exName">Exercise Name</label>
            <input type="text" id="edit-ex-name">
        </div>
        <div class="setting-group">
            <label data-key="targetType">Target Type</label>
            <select id="target-type" onchange="uiRefreshSettings()">
                <option value="fixed" data-key="fixedDaily">Fixed Daily Number</option>
                <option value="incremental" data-key="incremental">Incremental (Days)</option>
            </select>
        </div>
        <div id="group-incremental" class="setting-group" style="display:none">
            <label data-key="startDate">Start Date</label>
            <div class="custom-input" onclick="openCalendar('setting')">
                <span id="setting-start-date-display" data-key="selectDate">Select date</span>
                <span style="opacity:0.5; font-size:12px;">▼</span>
            </div>
        </div>
        <div id="group-fixed" class="setting-group">
            <label data-key="fixedVal">Fixed Value</label>
            <input type="number" id="fixed-val">
        </div>
        <button class="delete-ex-btn" onclick="deleteCurrentExercise()" data-key="delEx">DELETE EXERCISE</button>
        <button class="close-btn" onclick="saveSettings()" data-key="save">SAVE</button>
    </div>

    <div class="top-stats-container" id="header-container">
        <div class="stat-box left" onclick="togglePanel('settings-panel')">
            <div class="label"><span data-key="target">Target</span> ⚙️</div>
            <div class="val-text" id="target-val">0</div>
        </div>
        <div class="stat-box center" onclick="togglePanel('exercises-panel')">
            <div class="label"><span data-key="exercise">Exercise</span> <span class="arrow">▼</span></div>
            <div class="ex-title">
                <div id="ex-name-disp">...</div>
            </div>
        </div>
        <div class="stat-box right">
            <div class="label-mask">
                <div class="label-reel" id="rem-label-reel">
                    <span data-key="remaining">Remaining</span>
                    <span style="color:var(--bonus)" data-key="bonus">Bonus</span>
                </div>
            </div>
            <div class="val-text rem-text" id="rem-val">0</div>
        </div>
    </div>

    <div class="slider-container" id="prog-wrap">
        <div class="progress-fill" id="fill"></div>
        <input type="range" id="slider" min="0" value="0">
    </div>

    <div class="wheel-container" id="wheel-container">
        <div class="wheel" id="wheel"></div>
        <div class="wheel-center" id="wheel-center">
            <div id="inc"></div>
        </div>
    </div>

    <div class="stats-zone" onclick="togglePanel('history-panel')">
        <div class="label" data-key="totalToday">Total Today</div>
        <div class="done-val" id="done">0</div>
        <div class="discrete-hint main-page-hint" data-key="tapHistory">(Tap for history)</div>
    </div>

    <div class="buttons">
        <button onclick="add(1)">+1</button>
        <button onclick="add(5)">+5</button>
        <button onclick="add(10)">+10</button>
    </div>

    <div class="copyright">
        <span>&copy; BOANSKA • FitBsk • v5.0</span>
    </div>
</div>

<script>
/* ===== TRANSLATIONS ===== */
const translations = {
    en: {
        chooseEx: "Choose Exercise",
        back: "BACK",
        today: "Today",
        swipeHint: "Swipe left to delete",
        advOpt: "Advanced Options",
        month: "Month",
        year: "Year",
        close: "CLOSE",
        exSetup: "Exercise Setup",
        exName: "Exercise Name",
        targetType: "Target Type",
        fixedDaily: "Fixed Daily Number",
        incremental: "Incremental (Days)",
        startDate: "Start Date",
        selectDate: "Select date",
        fixedVal: "Fixed Value",
        delEx: "DELETE EXERCISE",
        save: "SAVE",
        target: "Target",
        exercise: "Exercise",
        remaining: "Remaining",
        bonus: "Bonus",
        totalToday: "Total Today",
        tapHistory: "(Tap for history)",
        addEx: "+ Add New Exercise",
        delConfirm: "Are you sure you want to delete this exercise?",
        delMsg: "You must have at least one exercise!",
        newExPrompt: "New Exercise Name:",
        pushups: "Pushups",
        emptyHist: "No records found.",
        delete: "DELETE",
        imported: "Imported!",
        error: "Error!",
        overwriteWarn: "Warning, data will be overwritten!",
        months: ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'],
        days: ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'],
        daysShort: ['M','T','W','T','F','S','S']
    },
    ro: {
        chooseEx: "Alege Exercițiul",
        back: "ÎNAPOI",
        today: "Azi",
        swipeHint: "Glisează stânga pentru ștergere",
        advOpt: "Opțiuni Avansate",
        month: "Luna",
        year: "An",
        close: "ÎNCHIDE",
        exSetup: "Configurare Exercițiu",
        exName: "Nume Exercițiu",
        targetType: "Tip Țintă",
        fixedDaily: "Număr Fix Zilnic",
        incremental: "Incremental (Zile)",
        startDate: "Data de Start",
        selectDate: "Selectează data",
        fixedVal: "Valoare Fixă",
        delEx: "ȘTERGE EXERCIȚIUL",
        save: "SALVEAZĂ",
        target: "Țintă",
        exercise: "Exercițiu",
        remaining: "Rămas",
        bonus: "Bonus",
        totalToday: "Total Azi",
        tapHistory: "(Apasă pentru istoric)",
        addEx: "+ Adaugă Exercițiu Nou",
        delConfirm: "Sigur ștergi acest exercițiu?",
        delMsg: "Trebuie să ai cel puțin un exercițiu!",
        newExPrompt: "Nume exercițiu nou:",
        pushups: "Flotări",
        emptyHist: "Nicio înregistrare.",
        delete: "ȘTERGE",
        imported: "Importat!",
        error: "Eroare!",
        overwriteWarn: "Atenție, datele vor fi suprascrise!",
        months: ['Ian','Feb','Mar','Apr','Mai','Iun','Iul','Aug','Sep','Oct','Nov','Dec'],
        days: ['Dum','Lun','Mar','Mie','Joi','Vin','Sâm'],
        daysShort: ['L','M','M','J','V','S','D']
    }
};

/* ===== DATA STATE ===== */
const STORAGE_KEY = 'fitbsk_v4_4';
let state = {
    lang: 'en', // Default English
    exercises: [{ id: 1, name: 'Pushups', settings: { type: 'fixed', fixedVal: 30, startDate: '2026-01-01' } }],
    currentExId: 1,
    dailyLog: {}, 
    lastUpdate: new Date().toDateString()
};

let currentTotalVal = 0; 
let checkpointMin = 0;
let timer = null; 
let incTimer = null; 
let targetMetFlag = false;

/* ===== I18N LOGIC ===== */
function t(key) {
    return translations[state.lang][key] || key;
}

function applyLanguage() {
    // Update static elements
    document.querySelectorAll('[data-key]').forEach(el => {
        el.innerText = t(el.getAttribute('data-key'));
    });
    // Update dynamic button text
    document.getElementById('lang-disp').textContent = state.lang.toUpperCase();
    
    // Refresh lists and UI that contain text
    updateUI(false);
    renderExercisesList();
    if(document.getElementById('history-panel').style.display === 'flex') renderHistoryList();
}

function toggleLang() {
    state.lang = state.lang === 'en' ? 'ro' : 'en';
    saveData();
    applyLanguage();
}

/* ===== WAKE LOCK + AUDIO INIT ===== */
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
let wakeLock = null;
let wakeLockTimer = null;

async function manageWakeLock() {
    if (!wakeLock && 'wakeLock' in navigator) {
        try { wakeLock = await navigator.wakeLock.request('screen'); } catch (err) {}
    }
    clearTimeout(wakeLockTimer);
    wakeLockTimer = setTimeout(() => {
        if (wakeLock) { wakeLock.release().then(() => { wakeLock = null; }); }
    }, 5 * 60 * 1000); 
}

function unlockAudioAndWakeLock() {
    manageWakeLock();
    if (audioCtx.state === 'suspended') {
        audioCtx.resume().then(() => {
            const buffer = audioCtx.createBuffer(1, 1, 22050);
            const source = audioCtx.createBufferSource();
            source.buffer = buffer; source.connect(audioCtx.destination); source.start(0);
        });
    }
}

document.addEventListener('click', unlockAudioAndWakeLock);
document.addEventListener('touchstart', unlockAudioAndWakeLock);
document.addEventListener('keydown', unlockAudioAndWakeLock);

function playTickSound() {
    if(audioCtx.state === "suspended") audioCtx.resume();
    const d=0.02, b=audioCtx.createBuffer(1,audioCtx.sampleRate*d,audioCtx.sampleRate), dt=b.getChannelData(0); 
    for(let i=0;i<dt.length;i++)dt[i]=(Math.random()*2-1)*Math.exp(-i/(dt.length/6)); 
    const s=audioCtx.createBufferSource(),g=audioCtx.createGain(); 
    g.gain.value=0.08; s.buffer=b; s.connect(g); g.connect(audioCtx.destination); s.start(); 
}

function playBellSound() {
    if(audioCtx.state === "suspended") audioCtx.resume();
    const t = audioCtx.currentTime;
    const osc1 = audioCtx.createOscillator(); const osc2 = audioCtx.createOscillator(); const gain = audioCtx.createGain();
    osc1.frequency.value = 3375; osc2.frequency.value = 4500; 
    osc1.connect(gain); osc2.connect(gain); gain.connect(audioCtx.destination);
    gain.gain.setValueAtTime(0.1, t); gain.gain.exponentialRampToValueAtTime(0.001, t + 1.2);
    osc1.start(t); osc2.start(t); osc1.stop(t + 1.2); osc2.stop(t + 1.2);
}

function playSaveSound() {
    if(audioCtx.state === "suspended") audioCtx.resume();
    const t = audioCtx.currentTime;
    const osc1 = audioCtx.createOscillator(); const osc2 = audioCtx.createOscillator(); const gain = audioCtx.createGain();
    osc1.frequency.value = 800; osc2.frequency.value = 1600; 
    osc1.connect(gain); osc2.connect(gain); gain.connect(audioCtx.destination);
    gain.gain.setValueAtTime(0.04, t); gain.gain.exponentialRampToValueAtTime(0.001, t + 0.6);
    osc1.start(t); osc2.start(t); osc1.stop(t + 0.6); osc2.stop(t + 0.6);
}

/* ===== CORE FUNCTIONS ===== */
function loadData() {
    const saved = localStorage.getItem(STORAGE_KEY);
    if (saved) {
        try { state = { ...state, ...JSON.parse(saved) }; } catch(e) {}
    }
    // Backward compatibility for lang
    if (!state.lang) state.lang = 'en';

    if (!state.exercises || state.exercises.length === 0) {
        state.exercises = [{ id: Date.now(), name: t('pushups'), settings: { type: 'fixed', fixedVal: 30, startDate: '2026-01-01' } }];
        state.currentExId = state.exercises[0].id;
    }
    calculateCurrentTotal();
    applyLanguage(); // Apply saved language
}

function saveData() { localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }

function calculateCurrentTotal() {
    const today = new Date().toDateString();
    const logs = state.dailyLog[today] || [];
    const exLogs = logs.filter(l => l.exId === state.currentExId);
    currentTotalVal = exLogs.reduce((acc, curr) => acc + curr.val, 0);
    checkpointMin = currentTotalVal;
}

function getCurrentEx() { return state.exercises.find(e => e.id === state.currentExId) || state.exercises[0]; }

function calculateTarget() {
    const ex = getCurrentEx();
    const s = ex.settings;
    if (s.type === 'fixed') return parseInt(s.fixedVal);
    const start = new Date(s.startDate); start.setHours(0,0,0,0);
    const today = new Date(); today.setHours(0,0,0,0);
    const diffDays = Math.ceil((today - start) / (1000 * 60 * 60 * 24)); 
    return Math.max(1, diffDays + 1);
}

/* ===== UI UPDATES ===== */
const slider = document.getElementById("slider"), progWrap = document.getElementById("prog-wrap"), fill = document.getElementById("fill");
const wheel = document.getElementById("wheel"), incDisp = document.getElementById("inc");
const headerCont = document.getElementsByClassName("top-stats-container")[0];
const sliderContainer = document.querySelector('.slider-container');
const wheelCenter = document.getElementById('wheel-center');

wheelCenter.addEventListener('click', () => {
    if (incDisp.classList.contains('show')) {
        manualSave();
    }
});

function updateUI(shouldTick) {
    const target = calculateTarget();
    const ex = getCurrentEx();
    
    document.getElementById('target-val').textContent = target;
    document.getElementById('ex-name-disp').textContent = ex.name;
    
    const remValDiv = document.getElementById('rem-val');
    const labelReel = document.getElementById('rem-label-reel');
    
    const isBonus = currentTotalVal >= target;

    if (isBonus && !targetMetFlag) {
        playBellSound();
        targetMetFlag = true;
    } else if (currentTotalVal < target) {
        targetMetFlag = false;
    }

    if (isBonus) {
        labelReel.style.transform = "translateY(-12px)";
        remValDiv.textContent = currentTotalVal - target;
        remValDiv.className = "val-text bonus-text";
        headerCont.classList.remove('active-progress'); headerCont.classList.add('active-bonus');
        progWrap.classList.add('bonus-mode');
        sliderContainer.classList.add('bonus-mode');
    } else {
        labelReel.style.transform = "translateY(0)";
        remValDiv.textContent = Math.max(0, target - currentTotalVal);
        remValDiv.className = "val-text rem-text";
        headerCont.classList.add('active-progress'); headerCont.classList.remove('active-bonus');
        progWrap.classList.remove('bonus-mode');
        sliderContainer.classList.remove('bonus-mode');
    }

    document.getElementById('done').textContent = currentTotalVal;
    slider.max = target; slider.value = Math.min(currentTotalVal, target);
    
    const pct = target > 0 ? (Math.min(currentTotalVal, target) / target) * 100 : 0;
    fill.style.width = pct + "%";
    wheel.style.transform = `rotate(${currentTotalVal * 10}deg)`;

    const diff = currentTotalVal - checkpointMin;
    if (diff > 0) {
        incDisp.textContent = `+${diff}`; 
        incDisp.classList.add('show');
        incDisp.style.color = isBonus ? "var(--bonus)" : "var(--primary)";
        wheelCenter.classList.add('can-save');
        clearTimeout(incTimer);
        incTimer = setTimeout(() => { 
            incDisp.classList.remove('show'); 
            wheelCenter.classList.remove('can-save');
        }, 5000);
    } else if (!incDisp.classList.contains('evaporate')) {
        incDisp.classList.remove('show'); incDisp.textContent = "";
        wheelCenter.classList.remove('can-save');
    }

    if (shouldTick) playTickSound();
}

/* ===== LOGIC ===== */
let listStartX = 0, listStartY = 0;
function exListDown(e) { listStartX = e.clientX || e.touches[0].clientX; listStartY = e.clientY || e.touches[0].clientY; }
function selectEx(id, e) {
    let endX = e.clientX || e.changedTouches[0].clientX;
    let endY = e.clientY || e.changedTouches[0].clientY;
    if (Math.abs(endX - listStartX) < 10 && Math.abs(endY - listStartY) < 10) {
        switchExercise(id);
    }
}

function switchExercise(id) {
    state.currentExId = id;
    calculateCurrentTotal();
    targetMetFlag = (currentTotalVal >= calculateTarget());
    saveData();
    updateUI(false);
    togglePanel('exercises-panel');
}

function addNewExercisePrompt() {
    const name = prompt(t('newExPrompt'));
    if (name) {
        const newEx = {
            id: Date.now(),
            name: name,
            settings: { type: 'fixed', fixedVal: 30, startDate: new Date().toISOString().split('T')[0] }
        };
        state.exercises.push(newEx);
        state.currentExId = newEx.id;
        calculateCurrentTotal();
        targetMetFlag = false;
        saveData();
        renderExercisesList();
        updateUI(false);
    }
}

function deleteCurrentExercise() {
    if (state.exercises.length <= 1) { alert(t('delMsg')); return; }
    if (!confirm(t('delConfirm'))) return;
    state.exercises = state.exercises.filter(e => e.id !== state.currentExId);
    state.currentExId = state.exercises[0].id;
    calculateCurrentTotal();
    targetMetFlag = (currentTotalVal >= calculateTarget());
    saveData();
    document.getElementById('settings-panel').style.display = 'none';
    updateUI(false);
}

function renderExercisesList() {
    const list = document.getElementById('exercises-list');
    let html = state.exercises.map(ex => `
        <div class="ex-list-item" onmousedown="exListDown(event)" onmouseup="selectEx(${ex.id}, event)" ontouchstart="exListDown(event)" ontouchend="selectEx(${ex.id}, event)">
            <span class="ex-item-name" style="${ex.id === state.currentExId ? 'color:var(--primary)' : ''}">${ex.name}</span>
            <div class="ex-status-dot ${ex.id === state.currentExId ? 'active' : ''}"></div>
        </div>
    `).join('');
    html += `<div class="add-ex-item" onclick="addNewExercisePrompt()">${t('addEx')}</div>`;
    list.innerHTML = html;
}

function saveSettings() {
    const ex = getCurrentEx();
    ex.name = document.getElementById('edit-ex-name').value;
    ex.settings.type = document.getElementById('target-type').value;
    ex.settings.fixedVal = document.getElementById('fixed-val').value;
    saveData();
    updateUI(false);
    document.getElementById('settings-panel').style.display = 'none';
}

function add(n) { 
    const prevVal = currentTotalVal;
    currentTotalVal += n;
    if (currentTotalVal < checkpointMin) currentTotalVal = checkpointMin;
    const hasChanged = currentTotalVal !== prevVal;
    manageWakeLock();
    updateUI(hasChanged); 
    resetSessionTimer();
}

function manualSave() { manageWakeLock(); if (currentTotalVal > checkpointMin) { finalizeSession(); clearTimeout(timer); } }
function resetSessionTimer() { clearTimeout(timer); timer = setTimeout(finalizeSession, 5000); }

function finalizeSession() {
    const diff = currentTotalVal - checkpointMin;
    if (diff > 0) {
        const today = new Date().toDateString();
        const entry = {
            id: Date.now(),
            time: new Date().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}),
            val: diff,
            exId: state.currentExId,
            exName: getCurrentEx().name
        };
        if (!state.dailyLog[today]) state.dailyLog[today] = [];
        state.dailyLog[today].unshift(entry);
        checkpointMin = currentTotalVal;
        saveData();
        playSaveSound(); 
        incDisp.classList.add('evaporate');
        wheelCenter.classList.remove('can-save');
        setTimeout(() => { incDisp.textContent=""; incDisp.classList.remove('show','evaporate'); }, 400);
    } else {
        incDisp.classList.remove('show');
        wheelCenter.classList.remove('can-save');
    }
}

/* ===== HISTORY LOGIC & ARROWS ===== */
function getAvailableDates() {
    const dates = Object.keys(state.dailyLog).filter(d => state.dailyLog[d].length > 0);
    const today = new Date().toDateString();
    if (!dates.includes(today)) dates.push(today);
    return dates.sort((a,b) => new Date(a) - new Date(b));
}

function updateNavArrows() {
    const dates = getAvailableDates();
    const idx = dates.indexOf(viewDateStr);
    
    const left = document.getElementById('nav-left');
    const right = document.getElementById('nav-right');
    
    if (idx > 0) left.classList.remove('disabled'); else left.classList.add('disabled');
    if (idx < dates.length - 1) right.classList.remove('disabled'); else right.classList.add('disabled');
}

function renderHistoryList() {
    document.getElementById('nav-date-display').textContent = formatDate(viewDateStr);
    const list = document.getElementById("history-list");
    const items = state.dailyLog[viewDateStr] || [];
    
    if (items.length === 0) list.innerHTML = `<div style="padding:40px;opacity:0.3;text-align:center">${t('emptyHist')}</div>`;
    else {
        list.innerHTML = items.map((item, index) => `
            <div class="swipe-container" id="hist-${index}">
                <div class="delete-btn" onclick="deleteHistoryItem(${index}, ${item.val}, ${item.exId})">${t('delete')}</div>
                <div class="swipe-content" onpointerdown="swipeStart(event)" onpointermove="swipeMove(event)" onpointerup="swipeEnd(event)" onpointerleave="swipeEnd(event)">
                    <div class="hist-left">
                        <span class="hist-name">${item.exName}</span>
                        <span class="hist-time">${item.time}</span>
                    </div>
                    <strong class="hist-val">+${item.val}</strong>
                </div>
            </div>
        `).join('');
    }
    initDesktopDragScroll('history-list');
    updateNavArrows();
}

function navHistoryDay(dir) {
    manageWakeLock();
    const dates = getAvailableDates();
    let idx = dates.indexOf(viewDateStr);
    const newIdx = idx + dir;
    
    if (newIdx >= 0 && newIdx < dates.length) {
        viewDateStr = dates[newIdx];
        renderHistoryList();
    }
}

function deleteHistoryItem(index, val, exId) {
    const el = document.getElementById(`hist-${index}`);
    el.classList.add('deleting'); activeSwipeEl = null;
    manageWakeLock();
    if (viewDateStr === new Date().toDateString() && exId === state.currentExId) {
        currentTotalVal = Math.max(0, currentTotalVal - val);
        checkpointMin = Math.max(0, checkpointMin - val);
        updateUI(false);
    }
    setTimeout(() => {
        state.dailyLog[viewDateStr].splice(index, 1);
        saveData();
        renderHistoryList();
    }, 350);
}

/* ===== SWIPE LOGIC ===== */
let startX=0, startY=0, isSwipeAction=false, pointerDown=false, activeSwipeEl=null, initialTranslate=0;

function swipeStart(e){ 
    if(e.pointerType==='mouse' && e.button!==0)return;
    if(activeSwipeEl && activeSwipeEl!==e.currentTarget){ activeSwipeEl.style.transform='translateX(0)'; activeSwipeEl=null; }
    startX=e.clientX; startY=e.clientY; isSwipeAction=false; pointerDown=true;
    manageWakeLock();
    e.currentTarget.style.transition='none'; e.currentTarget.setPointerCapture(e.pointerId);
    const m = new DOMMatrix(window.getComputedStyle(e.currentTarget).transform); initialTranslate=m.m41;
}
function swipeMove(e){ 
    if(!pointerDown)return; 
    const dx=e.clientX-startX, dy=e.clientY-startY;
    if(!isSwipeAction){ if(Math.abs(dy)>Math.abs(dx))return; if(Math.abs(dx)>5)isSwipeAction=true; }
    if(isSwipeAction){ e.preventDefault(); let newT=initialTranslate+dx; newT=Math.max(-80,Math.min(0,newT)); e.currentTarget.style.transform=`translateX(${newT}px)`; }
}
function swipeEnd(e){ 
    pointerDown=false; isSwipeAction=false; try{e.currentTarget.releasePointerCapture(e.pointerId);}catch(e){}
    e.currentTarget.style.transition='transform 0.2s ease-out';
    const m = new DOMMatrix(window.getComputedStyle(e.currentTarget).transform);
    if(m.m41 < -40){ e.currentTarget.style.transform='translateX(-80px)'; activeSwipeEl=e.currentTarget; }
    else{ e.currentTarget.style.transform='translateX(0)'; if(activeSwipeEl===e.currentTarget)activeSwipeEl=null; }
}

function initDesktopDragScroll(id) {
    const list = document.getElementById(id);
    let isDown=false, sY, sT;
    list.onmousedown=(e)=>{if(isSwipeAction)return;isDown=true;sY=e.pageY-list.offsetTop;sT=list.scrollTop;list.style.cursor='grabbing';manageWakeLock();};
    window.addEventListener('mouseup', ()=>{isDown=false;if(list)list.style.cursor='grab';});
    window.addEventListener('mousemove',(e)=>{if(!isDown||isSwipeAction)return;e.preventDefault();const y=e.pageY-list.offsetTop;const walk=(y-sY);list.scrollTop=sT-walk;});
}

/* ===== NAV & CALENDAR ===== */
function formatDate(dateStr) {
    const d = new Date(dateStr); d.setHours(0,0,0,0);
    const today = new Date(); today.setHours(0,0,0,0);
    if (d.getTime() === today.getTime()) return t('today');
    
    // Get translated day/month arrays
    const days = translations[state.lang].days;
    const months = translations[state.lang].months;
    
    return `${days[d.getDay()]}, ${d.getDate()} ${months[d.getMonth()]}`;
}

/* ===== SETTINGS & PANELS ===== */
function togglePanel(id) {
    manageWakeLock();
    const p = document.getElementById(id);
    const isOpen = p.style.display === "flex";
    p.style.display = isOpen ? 'none' : 'flex';
    
    if (!isOpen) {
        if(id==='settings-panel') {
            const ex = getCurrentEx();
            document.getElementById('edit-ex-name').value = ex.name;
            document.getElementById('target-type').value = ex.settings.type;
            document.getElementById('setting-start-date-display').textContent = formatDate(ex.settings.startDate);
            document.getElementById('fixed-val').value = ex.settings.fixedVal;
            uiRefreshSettings();
        } else if (id==='history-panel') {
            viewDateStr = new Date().toDateString(); renderHistoryList();
        } else if (id==='exercises-panel') {
            renderExercisesList();
        }
    }
}

function uiRefreshSettings(){ document.getElementById('group-incremental').style.display=document.getElementById('target-type').value==='incremental'?'block':'none'; document.getElementById('group-fixed').style.display=document.getElementById('target-type').value==='fixed'?'block':'none'; }

/* ===== CALENDAR (Compact) ===== */
function openCalendar(ctx) {
    calendarContext = ctx;
    calViewDate = new Date(ctx==='history'?viewDateStr:getCurrentEx().settings.startDate);
    setCalendarView('days');
    document.getElementById('calendar-panel').style.display='flex';
}
function closeCalendar() { document.getElementById('calendar-panel').style.display='none'; }
function setCalendarView(mode) {
    calViewMode=mode;
    const m=document.getElementById('cal-title-month'), y=document.getElementById('cal-title-year');
    m.style.display='none'; m.classList.remove('active'); y.classList.remove('active');
    if(mode==='days'){m.style.display='block';m.classList.add('active');y.classList.add('active');renderCalDays();}
    else if(mode==='months'){y.classList.add('active');renderCalMonths();}
    else {y.classList.add('active');renderCalYears();}
}
function navCalendar(d) {
    if(calViewMode==='days')calViewDate.setMonth(calViewDate.getMonth()+d);
    else if(calViewMode==='months')calViewDate.setFullYear(calViewDate.getFullYear()+d);
    else calViewDate.setFullYear(calViewDate.getFullYear()+(d*10));
    setCalendarView(calViewMode);
}
function renderCalDays() {
    const g=document.getElementById('cal-grid'); g.className='cal-grid days'; g.innerHTML='';
    const y=calViewDate.getFullYear(), m=calViewDate.getMonth();
    // Use translated months
    document.getElementById('cal-title-month').textContent=translations[state.lang].months[m];
    document.getElementById('cal-title-year').textContent=y;
    // Use translated days short
    translations[state.lang].daysShort.forEach(d=>g.innerHTML+=`<div class="cal-day-header">${d}</div>`);
    
    const f=new Date(y,m,1).getDay()||7, dim=new Date(y,m+1,0).getDate(), lim=new Date(); lim.setDate(lim.getDate()-365); lim.setHours(0,0,0,0);
    for(let i=1;i<f;i++)g.innerHTML+=`<div></div>`;
    for(let d=1;d<=dim;d++){
        const dojb=new Date(y,m,d), dStr=dojb.toDateString();
        let cls='cal-cell';
        if(dStr===new Date().toDateString())cls+=' today';
        const selTarget = calendarContext==='history'?viewDateStr:getCurrentEx().settings.startDate;
        const selComp = calendarContext==='history'?dStr:dojb.toISOString().split('T')[0];
        if(selComp===selTarget)cls+=' selected';
        if(state.dailyLog[dStr] && state.dailyLog[dStr].length>0) cls+=' has-data';
        if(calendarContext==='setting' && dojb<lim) g.innerHTML+=`<div class="${cls} disabled">${d}</div>`;
        else g.innerHTML+=`<div class="${cls}" onclick="selectDate('${dStr}')">${d}<div class="cal-dot"></div></div>`;
    }
}
function renderCalMonths() {
    const g=document.getElementById('cal-grid'); g.className='cal-grid months'; g.innerHTML='';
    document.getElementById('cal-title-year').textContent=calViewDate.getFullYear();
    translations[state.lang].months.forEach((m,i)=>{
        let cls='cal-big-cell'; if(i===calViewDate.getMonth())cls+=' current';
        for(let k in state.dailyLog){const d=new Date(k);if(d.getFullYear()===calViewDate.getFullYear() && d.getMonth()===i){cls+=' has-data'; break;}}
        g.innerHTML+=`<div class="${cls}" onclick="calViewDate.setMonth(${i});setCalendarView('days')">${m}<div class="cal-dot"></div></div>`;
    });
}
function renderCalYears() {
    const g=document.getElementById('cal-grid'); g.className='cal-grid years'; g.innerHTML='';
    const sy=Math.floor(calViewDate.getFullYear()/10)*10;
    document.getElementById('cal-title-year').textContent=`${sy}-${sy+9}`;
    for(let y=sy-1;y<=sy+10;y++){
        let cls='cal-big-cell'; if(y===calViewDate.getFullYear())cls+=' current';
        for(let k in state.dailyLog){if(new Date(k).getFullYear()===y){cls+=' has-data'; break;}}
        g.innerHTML+=`<div class="${cls}" onclick="calViewDate.setFullYear(${y});setCalendarView('months')">${y}<div class="cal-dot"></div></div>`;
    }
}
function selectDate(s) {
    if(calendarContext==='history'){ viewDateStr=s; renderHistoryList(); }
    else { 
        const d=new Date(s), y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), day=String(d.getDate()).padStart(2,'0');
        document.getElementById('setting-start-date-display').textContent=formatDate(s);
        getCurrentEx().settings.startDate = `${y}-${m}-${day}`;
    }
    closeCalendar();
}

/* ===== BACKUP ===== */
function toggleAdvanced(){document.getElementById('advanced-menu').classList.toggle('open');}
function exportData(){
    saveData();
    const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([JSON.stringify(state)],{type:"application/json"}));
    a.download=`FitBsk_backup_${new Date().toISOString().split('T')[0]}.json`; document.body.appendChild(a); a.click(); document.body.removeChild(a);
}
function importData(inp){
    const f=inp.files[0]; if(!f||!confirm(t('overwriteWarn')))return;
    const r=new FileReader(); r.onload=e=>{
        try{
            state=JSON.parse(e.target.result); 
            saveData(); 
            loadData(); 
            updateUI(false); 
            alert(t('imported'));
        }catch{alert(t('error'));}
    };
    r.readAsText(f); inp.value='';
}

slider.addEventListener("input",e=>{ const v=parseInt(e.target.value); if(v>=checkpointMin){currentTotalVal=v;updateUI(true);resetSessionTimer();} });

// Wheel Logic
const wBox=document.getElementById('wheel-container');
let isD=false, lA=0;
function getA(x,y){const r=wBox.getBoundingClientRect();return Math.atan2(y-(r.top+r.height/2),x-(r.left+r.width/2))*180/Math.PI;}
wBox.addEventListener('touchstart',e=>{isD=true;lA=getA(e.touches[0].clientX,e.touches[0].clientY);manageWakeLock();},{passive:true});
window.addEventListener('touchmove',e=>{if(!isD)return;const a=getA(e.touches[0].clientX,e.touches[0].clientY);let d=a-lA;if(d>180)d-=360;if(d<-180)d+=360;if(Math.abs(d)>10){add(d>0?1:-1);lA=a;}},{passive:false});
window.addEventListener('touchend',()=>isD=false);
wBox.addEventListener('mousedown',e=>{isD=true;lA=getA(e.clientX,e.clientY);manageWakeLock();});
window.addEventListener('mousemove',e=>{if(!isD)return;const a=getA(e.clientX,e.clientY);let d=a-lA;if(d>180)d-=360;if(d<-180)d+=360;if(Math.abs(d)>10){add(d>0?1:-1);lA=a;}});
window.addEventListener('mouseup',()=>isD=false);

// Init
loadData();
</script>
</body>
</html>
